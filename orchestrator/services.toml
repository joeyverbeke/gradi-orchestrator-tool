version = 1

[defaults]
restart_delay_seconds = 5
stop_timeout_seconds = 10

[services.vllm]
display_name = "Gradi vLLM"
working_dir = "0_vllm"
venv = ".venv"
command = """
uv run vllm serve hugging-quants/Meta-Llama-3.1-8B-Instruct-GPTQ-INT4 \
  --quantization gptq_marlin \
  --dtype half \
  --max-model-len 4096 \
  --gpu-memory-utilization 0.82 \
  --tensor-parallel-size 1 \
  --enforce-eager
"""
dependencies = []
requires_devices = []
[services.vllm.health]
type = "http"
url = "http://127.0.0.1:8000/health"
initial_delay_seconds = 30
interval_seconds = 5
failure_threshold = 3

[services.kokoro]
display_name = "Gradi Kokoro"
working_dir = "1_tts/Kokoro-FastAPI"
venv = "../.venv"
command = "./start-gpu.sh"
dependencies = []
requires_devices = []
[services.kokoro.health]
type = "http"
url = "http://127.0.0.1:8880/health"
initial_delay_seconds = 8
interval_seconds = 5
failure_threshold = 3

[services.gradi-mediate]
display_name = "Gradi Mediation"
working_dir = "2_gradi-mediate/gradi-mediation"
venv = ".venv"
command = """
uv run scripts/session_controller.py \
  --asr-engine faster_whisper \
  --fw-model-dir third_party/faster-whisper/models \
  --kokoro-voice af_bella
"""
dependencies = ["vllm", "kokoro"]
requires_devices = ["/dev/gradi-esp-mediate"]

[services.gradi-calibrate]
display_name = "Gradi Calibrate"
working_dir = "3_gradi-calibrate"
venv = ".venv"
command = "python -m pc_app.cli --audio --language ko"
testing_command = "python -m pc_app.cli --audio --language en"
dependencies = []
requires_devices = ["/dev/gradi-rp-calibrate"]

[services.gradi-predict]
display_name = "Gradi Predict"
working_dir = "4_gradi-predict"
venv = ".venv"
command = "python src/main.py --language en --logging"
dependencies = []
requires_devices = ["/dev/gradi-esp-predict"]

[services.gradi-compress]
display_name = "Gradi Compress"
working_dir = "5_gradi-compress"
command = "npm start -- --port /dev/gradi-esp-compress --fullscreen"
testing_command = "npm start -- --port /dev/gradi-esp-compress"
dependencies = []
requires_devices = ["/dev/gradi-esp-compress"]
device_restart_policy = "on_reconnect"
[services.gradi-compress.health]
type = "tcp"
host = "127.0.0.1"
port = 3007
interval_seconds = 5
failure_threshold = 3
